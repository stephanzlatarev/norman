<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Nidamasin Norman</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
</head>

<style>
  body { padding-top: 50px; }
  .info-right { float: right; margin: 0px 0.125rem; }
  .label-text:first-letter { text-transform: uppercase; }
  .bi::before, [class^="bi-"]::before, [class*=" bi-"]::before { vertical-align: 0px; }
</style>

<body>
  <div class="container">

    <div class="card">
      <div id="charts" class="card-body"></div>
    </div>
    <br />

    <div class="card">
      <h6 class="card-header">Goals</h6>
      <div id="goals" class="card-body"></div>
    </div>
    <br />

    <div class="card">
      <h6 class="card-header">Body</h6>
      <div id="body" class="card-body"></div>
    </div>
    <br />

</body>

<script type="text/javascript">

  const charts = [];

  function layoutCharts(layout) {
    const container = $("#charts");
    if (!container.is(':empty')) return;

    if (typeof(layout) === "number") {
      for (let i = 0; i < layout; i++) {
        container.append(`<div><canvas id="chart-${i}" style="width: 100%; height: 12rem"></canvas></div>`);
        container.append(`<div id="info-${i}"></div>`);
      }
    } else {
      layoutLevel(container, layout);
    }
  }

  function layoutLevel(container, layout) {
    if (layout.rows) {
      for (const row of layout.rows) {
        const rows = $(`<div class="row"></div>`).appendTo(container);
        layoutLevel(rows, row);
      }
    } else if (layout.cols) {
      for (const col of layout.cols) {
        const cols = $(`<div class="col"></div>`).appendTo(container);
        layoutLevel(cols, col);
      }
    } else if (layout.chart >= 0) {
      const height = layout.height ? layout.height * 12 : 12;
      container.append(`<div><canvas id="chart-${layout.chart}" style="width: 100%; height: ${height}rem"></canvas></div>`);
      container.append(`<div id="info-${layout.chart}"></div>`);
    }
  }

  function refreshCharts() {
    $.ajax({
      type: "POST", url: "/", contentType: "application/json",
      data: JSON.stringify({ action: "charts" }),
      success: function(data) {
        if (!data || !data.length) return;

        if (data[0].kind === "layout") {
          layoutCharts(data[0]);
          data.splice(0, 1);
        } else {
          layoutCharts(data.length);
        }

        for (let i = 0; i < data.length; i++) {
          const chart = data[i];

          let labels;
          const datasets = [];
          const info = [];
          const pointRadius = (chart.type === "scatter") ? calculatePointRadius(i, chart) : 0;
          for (const series of chart.series) {
            if (chart.type === "scatter") {
              datasets.push({ label: series.title, data: series.data, backgroundColor: series.color, pointRadius: pointRadius * series.size });
            } else {
              labels = chart.ticks.data;
              const normalized = normalizeChartLineData(series);
              datasets.push({ label: series.title, data: normalized.data, borderColor: series.color, borderWidth: 3, pointRadius: pointRadius, fill: false });
              info.push(Math.ceil(normalized.max) + " " + series.title.toLowerCase());
            }
          }

          if (!charts[chart.title]) {
            charts[chart.title] = new Chart("chart-" + i, {
              type: (chart.type === "scatter") ? "scatter" : "line",
              data: { labels: labels, datasets: datasets },
              options: { maintainAspectRatio: false, animation: false }
            });
          } else {
            charts[chart.title].data.labels = labels;
            charts[chart.title].data.datasets = datasets;
            charts[chart.title].update();
          }
          $("#info-" + i).text(info.join(", "));
        }
      }
    });
  }

  function normalizeChartLineData(series) {
    const raw = bundleChartData(series);
    const data = [];
    let min = Infinity;
    let max = -Infinity;
    for (const value of raw) {
      if (value !== null) {
        min = Math.min(value, min);
        max = Math.max(value, max);
      }
    }
    min = Math.min(min, 0);
    for (let i = 0; i < raw.length; i++) {
      if (raw[i] !== null) {
        data.push(100 * (raw[i] - min) / (max - min));
      } else {
        data.push(null);
      }
    }
    if (max === -Infinity) max = 0;
    return { data: data, min: min, max: max };
  }

  function calculatePointRadius(index, chart) {
    let minX = Infinity;
    let maxX = -Infinity;
    let minY = Infinity;
    let maxY = -Infinity;
    for (const series of chart.series) {
      for (const data of series.data) {
        minX = Math.min(data.x, minX);
        maxX = Math.max(data.x, maxX);
        minY = Math.min(data.y, minY);
        maxY = Math.max(data.y, maxY);
      }
    }
    const x = $("#chart-" + index).width() / (maxX - minX) / 3;
    const y = $("#chart-" + index).height() / (maxY - minY) / 3;
    return Math.min(x, y);
  }

  function bundleChartData(series) {
    if (series.per) {
      const data = [];
      for (let i = 0; i < series.data.length; i++) {
        if ((i >= series.per) && (series.data[i] !== null) && (series.data[i - series.per] !== null)) {
          data.push(series.data[i] - series.data[i - series.per]);
        } else {
          data.push(null);
        }
      }
      for (let i = 0; i < data.length; i += series.per) {
        let sum = 0;
        let ok = true;
        for (let j = 0; j < series.per; j++) {
          if (typeof(data[i + j]) === "number") {
            sum += data[i + j];
          } else {
            ok = false;
            break;
          }
        }
        const value = ok ? sum / series.per : null;
        for (let j = 0; j < series.per; j++) {
          data[i + j] = value;
        }
      }
      return data;
    }

    return series.data;
  }

  function refreshGoals() {
    $.ajax({
      type: "POST", url: "/", contentType: "application/json",
      data: JSON.stringify({ action: "list", node: { goal: true } }),
      success: function(data) {
        const list = $("<ul>").addClass("list-group").appendTo($("#goals").empty());
  
        for (const goal of data) {
          list.append(goalToItem(goal));
        }
      }
    });
  }

  function goalToItem(goal) {
    const item = $("<li>").addClass("list-group-item");

    $("<span>").addClass("label-text").css("display", "inline-block").text(goal.label).appendTo(item);
    $("<span>").css("margin-left", "1rem").css("color", "darkGray").text(listGoalProps(goal.props)).appendTo(item);

    return item;
  }

  function listGoalProps(props) {
    const line = [];

    for (const key in props) {
      if (key !== "goal") {
        line.push(key + ": " + props[key]);
      }
    }

    return line.join(" ãƒ» ");
  }

  function refreshBodies() {
    $.ajax({
      type: "POST", url: "/", contentType: "application/json",
      data: JSON.stringify({ action: "list", node: { type: "body" } }),
      success: function(data) {
        const list = $("<ul>").addClass("list-group").appendTo($("#body").empty());

        for (const body of data) {
          list.append(bodyToItem(body));
        }
      }
    });
  }

  function bodyToItem(body) {
    const item = $("<li>").addClass("list-group-item").text(body.label);
    const progress = body.props.progress;
    const attached = body.props.attached;
    const status = (attached && !progress) ? "attached" : null;

    if (progress) {
      const percentage = Math.min(95, Math.floor((new Date().getTime() - progress) / 300));
      const line = $("<div>").addClass("progress-bar").addClass("progress-bar-striped").addClass("progress-bar-animated")
        .attr("role", "progressbar").css("width", percentage + "%").append(status);
      $("<div>").addClass("progress").css("width", "65px").css("margin-left", "0.25rem").css("margin-top", "0.125rem").addClass("info-right").append(line).appendTo(item);

      setTimeout(refreshBodies, 1000);
    } else {
      if (attached) {
        $("<i>").addClass("bi-x-circle").addClass("info-right").css("cursor", "pointer")
        .click(() => detachBody(body.label))
        .appendTo(item);
      } else {
        $("<i>").addClass("bi-plus-circle").addClass("info-right").css("cursor", "pointer")
        .click(() => attachBody(body.label))
        .appendTo(item);
      }

      $("<span>").addClass("badge").addClass("text-bg-dark").addClass("info-right").append(status).appendTo(item);
    }
    $("<span>").addClass("badge").addClass("text-bg-secondary").addClass("info-right").append("#" + body.ref).appendTo(item);

    return item;
  }

  function attachBody(label) {
    $.ajax({
      type: "POST", url: "/", contentType: "application/json",
      data: JSON.stringify({ node: { label: label }, action: "set", key: "attaching", value: true }),
      success: () => setTimeout(refreshBodies, 1000)
    });
  }

  function detachBody(label) {
    $.ajax({
      type: "POST", url: "/", contentType: "application/json",
      data: JSON.stringify({ node: { label: label }, action: "set", key: "detaching", value: true }),
      success: () => setTimeout(refreshBodies, 1000)
    });
  }

  function refreshAll() {
    refreshCharts();
    refreshGoals();
    refreshBodies();

    setTimeout(refreshAll, 3000);
  }

  $(document).ready(refreshAll);
</script>

</html>
