<!DOCTYPE html>
<html>
<script src="jquery.min.js"></script>
<body>

<svg id="chart" width="1800" height="800"></svg>
<div id="sequence"></div>

<script type="text/javascript">
function x(second) {
  return second * 1800 / 60 / 12;
}
function y(value) {
  return 800 - value;
}
function maxy() {
  return 0;
}
function miny() {
  return 800;
}

function line(color, x1, y1, x2, y2) {
  const g = document.createElementNS("http://www.w3.org/2000/svg", "line");
  g.setAttribute("style", "stroke:" + color + ";stroke-width:1");
  g.setAttribute("x1", x1);
  g.setAttribute("y1", y1);
  g.setAttribute("x2", x2);
  g.setAttribute("y2", y2);
  $("#chart").append(g);
}

function path(color, dash, values) {
  const points = [];
  for (let seconds = 0; seconds < values.length; seconds++) points.push(x(seconds) + "," + y(values[seconds]));

  const g = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  g.setAttribute("style", "fill:none;stroke:" + color + ";stroke-width:3;stroke-dasharray:" + dash + "," + dash);
  g.setAttribute("points", points.join(" "));
  $("#chart").append(g);
}

function text(text, color, x, y) {
  const g = document.createElementNS("http://www.w3.org/2000/svg", "text");
  g.setAttribute("style", "stroke:" + color);
  g.setAttribute("x", x);
  g.setAttribute("y", y);
  g.textContent = text;
  $("#chart").append(g);
}

const HARVEST_MPS = 0.97;
const HARVEST_VPS = 0.90;

const STATE = {
  mineral: 0,
  vespene: 0,
  food: 0,
  supply: 0,
  mps: 0,
  vps: 0,
  nexus: 0,
  miner: 0,
  gaser: 0,
  assimilator: 0,
  pylon: 0,
  gateway: 0,
  cybernetics: 0,
  zealot: 0,
  stalker: 0,
  sentry: 0,
  strength: 0,
};

const COLOR = {
  mineral: "lightBlue",
  vespene: "lightGreen",
  supply: "lightGray",
  mps: "darkBlue",
  vps: "darkGreen",
};

const UNIT = {
  miner: { mineral: 50, food: 1, seconds: 12, factory: "nexus" },
  gaser: { mineral: 50, food: 1, seconds: 12, factory: "nexus" },
  nexus: { mineral: 400, seconds: 71 },
  pylon: { mineral: 100, seconds: 18 },
  assimilator: { mineral: 75, seconds: 21 },
  gateway: { mineral: 150, seconds: 46, requires: ["pylon"] },
  cybernetics: { mineral: 150, seconds: 36, requires: ["pylon", "gateway"] },
  zealot: { mineral: 100, food: 2, seconds: 27, factory: "gateway" },
  sentry: { mineral: 50, vespene: 100, food: 2, seconds: 23, factory: "gateway", requires: ["cybernetics"] },
  stalker: { mineral: 125, vespene: 50, food: 2, seconds: 30, factory: "gateway", requires: ["cybernetics"] },
};

const TYPES = Object.keys(UNIT);

function twodigits(number) {
  return (number >= 10) ? number : "0" + number;
}

function run(start, sequence, time) {
  const log = { text: [] };
  for (const key in STATE) log[key] = [];

  const current = {...STATE, ...start};
  const factories = {...STATE, ...start};
  const progress = {};
  const productions = [];

  for (const key in STATE) log[key].push(current[key]);
  for (const type in UNIT) progress[type] = 0;

  let blocks = {};

  for (let s = 1; s < time; s++) {
    current.supply = current.nexus * 15 + current.pylon * 8;
    current.mps = Math.min(current.miner, current.nexus * 16) * HARVEST_MPS;
    current.vps = Math.min(current.gaser, current.assimilator * 3, current.nexus * 6) * HARVEST_VPS;

    current.food = current.supply;
    for (const type in current) {
      if (UNIT[type] && UNIT[type].food) {
        current.food -= (current[type] + progress[type]) * UNIT[type].food;
      }
    }

    // Drop off factory production
    for (let i = productions.length - 1; i >=0; i--) {
      const production = productions[i];
      if (production.time === s) {
        current[production.type]++;
        progress[production.type]--;
        factories[production.type]++;
        factories[production.factory]++; // Free this factory
        productions.splice(i, 1);
      }
    }

    // Spend resources
    while (sequence.length) {
      const type = sequence[0];
      const unit = UNIT[type];
      if (unit.mineral && (current.mineral < unit.mineral)) { blocks["M"] = true; break; }
      if (current.vespene && (current.vespene < unit.vespene)) { blocks["V"] = true; break; }
      if (unit.food && (current.food < unit.food)) { blocks["F"] = true; break; }
      if (unit.factory && !factories[unit.factory]) { blocks["P"] = true; break; }
      if (unit.requires) {
        let isOk = true;
        for (const requirement of unit.requires) if (!current[requirement]) { isOk = false; break; }
        if (!isOk) { blocks["R"] = true; break; }
      }

      if (unit.mineral) current.mineral -= unit.mineral;
      if (unit.vespene) current.vespene -= unit.vespene;
      if (unit.food) current.food -= unit.food;

      if (unit.factory) {
        factories[unit.factory]--; // Reserve this factory
        productions.push({ type: type, time: s + unit.seconds, factory: unit.factory });
      } else {
        productions.push({ type: type, time: s + unit.seconds });
      }
      progress[type]++;

      sequence.splice(0, 1);
      log.text.push(
        type + " (" +
          Object.keys(blocks).join("") + "→" +
          Math.floor(s/60) + ":" + twodigits(s%60) + "→" +
          Math.floor((s+unit.seconds)/60) + ":" + twodigits((s+unit.seconds)%60) +
        ")"
      );
      blocks = {};
    }

    // Collect resources
    current.mineral += current.mps;
    current.vespene += current.vps;

    // Calculate strength
    current.strength = current.zealot * 10 + current.sentry * 10 + current.stalker * 10;

    // Log state
    for (const key in STATE) log[key].push(current[key]);
  }

  log.text.push(JSON.stringify(current));

  if (sequence.length) {
    log.text.push(sequence[0] + " blocked by: " + Object.keys(blocks).join(", "));
  }

  return log;
}

function show(start, logs, time) {
  console.log(logs);
  $("#chart").empty();
  for (let v = 0; v <= 800; v += 100) {
    line("darkGray", x(0), y(v), x(time), y(v));
    text(v, "darkGray", x(1), y(v + 5));
  }

  for (let second = 0; second <= time; second += 60) {
    line("darkGray", x(second), miny(), x(second), maxy());
    text(Math.floor(second / 60) + "'", "darkGray", x(second + 1), y(5));
  }

  $("#sequence").empty();
  for (const i in logs) {
    const log = logs[i];
    for (const line in COLOR) path(COLOR[line], i, log[line]);
    $("#sequence").append($("<div>").text(i + ": " + log.text.join("; ")));
  }
}

function generate(size) {
  const sequence = [];
  for (let i = 0; i < size; i++) {
    sequence.push(TYPES[Math.floor(Math.random() * TYPES.length)]);
  }
  return sequence;
}

$(document).ready(function() {
  const start = { mineral: 400, nexus: 1, assimilator: 2, pylon: 4, gateway: 2, cybernetics: 1, miner: 16, gaser: 6, zealot: 3, stalker: 3 };
  const time = 12 * 60;

  const best = [
    "nexus", "miner", "miner", "miner",
    "nexus", "miner", "miner", "miner",
    "nexus", "miner", "miner",
    "pylon", "miner", "miner", "miner", "miner",
    "pylon", "gateway", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner",
    "gateway", "miner", "miner", "miner",
    "pylon", "gateway", "miner", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner", "miner",
    "gateway", "zealot", "miner", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner", "miner",
    "gateway", "zealot", "miner", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner",
    "zealot", "zealot", "zealot",
    "pylon",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
  ];

  const test = [
    "nexus", "miner", "miner", "miner",
    "nexus", "miner", "miner", "miner",
    "nexus", "miner", "miner",
    "pylon", "miner", "miner",
    "gateway", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner",
    "gateway", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner", "miner",
    "gateway", "zealot", "miner", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner", "miner",
    "gateway", "zealot", "miner", "miner", "miner", "miner",
    "gateway", "pylon", "miner", "miner", "miner", "miner",
    "pylon", "miner", "miner", "miner",
    "zealot", "zealot", "zealot", "zealot",
    "pylon",
    "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
    "zealot", "zealot", "zealot", "zealot",
  ];

  show(start, [run(start, best, time), run(start, test, time)], time);

  /*
  let best;
  for (let i = 0; i < 100000; i++) {
    const log = run(start, generate(40), time);

    if (!best || (log.strength[time-1] > best.strength[time-1])) best = log;

    if (i%10000 === 0) show(start, [best, log], time);
  }
  */
});
</script>

</body>
</html>
